"use strict";
jQuery(document).ready(function (e) {

        if (wpiePluginSettings == null)
        {
                wpiePluginSettings = [];
        }

        if (wpiePluginSettings.wpieExportData == null)
        {
                wpiePluginSettings.wpieExportData = [];
        }

        if (wpiePluginSettings.processes == null)
        {
                wpiePluginSettings.processes = [];
        }

        if (typeof jQuery.fn.chosen === "function" && jQuery('.wpie_content_data_select').length) {
                jQuery('.wpie_content_data_select').chosen({search_contains: true});
        }

        if (typeof jQuery.fn.autoComplete === "function" && jQuery('.wpie_auto_complete').length) {

                jQuery('.autoComplete').autoComplete({
                        minChars: 0,
                        source: function (term, suggest) {
                                term = term.toLowerCase();
                                var choices = [['Australia', 'au'], ['Austria', 'at'], ['Brasil', 'br'], ['Bulgaria', 'bg'], ['Canada', 'ca'], ['China', 'cn'], ['Czech Republic', 'cz'], ['Denmark', 'dk'], ['Finland', 'fi'], ['France', 'fr'], ['Germany', 'de'], ['Hungary', 'hu'], ['India', 'in'], ['Italy', 'it'], ['Japan', 'ja'], ['Netherlands', 'nl'], ['Norway', 'no'], ['Portugal', 'pt'], ['Romania', 'ro'], ['Russia', 'ru'], ['Spain', 'es'], ['Swiss', 'ch'], ['Turkey', 'tr'], ['USA', 'us']];
                                var suggestions = [];
                                for (i = 0; i < choices.length; i++)
                                        if (~(choices[i][0] + ' ' + choices[i][1]).toLowerCase().indexOf(term))
                                                suggestions.push(choices[i]);
                                suggest(suggestions);
                        }
                });
        }

        wpieSetToolTip();

        if (wpiePluginSettings.isUploadDirWritable !== "1")
        {
                wpieSetStrictErrorMsg(wpiePluginSettings.wpieLocalizeText.uploadDirWritableError);
        }
});
function wpieSetToolTip() {
        if (typeof jQuery.fn.tipso === "function" && jQuery('.wpie_data_tipso').length) {
                jQuery('.wpie_data_tipso').tipso({
                        useTitle: false,
                        background: 'rgba(0,0,0,0.8)',
                        color: "#ffffff",
                        size: "small",
                        tooltipHover: true
                });
        }
}

jQuery(document).on('click', '.wpie_content_data_header', function () {

        var content_data = jQuery(this).closest('.wpie_section_wrapper').find('.wpie_section_content');

        if (jQuery(this).hasClass('wpie_section_wrapper_selected'))
        {
                jQuery(this).removeClass("wpie_section_wrapper_selected");

                if (jQuery(this).hasClass('wpie_field_mapping_section'))
                {
                        jQuery(this).closest('.wpie_section_wrapper').find('.wpie_field_mapping_fields_wrapper').slideUp();
                }

        } else {

                jQuery(this).addClass("wpie_section_wrapper_selected");

                if (jQuery(this).hasClass('wpie_field_mapping_section'))
                {
                        jQuery(this).closest('.wpie_section_wrapper').find('.wpie_field_mapping_fields_wrapper').slideDown();

                }
        }

        content_data.slideToggle("slow");

});
jQuery(document).on('change', '.wpie_scheduled_send_email_chk', function () {

        jQuery(this).closest('td').find('.wpie_options_data_send_mail').slideToggle();

});
jQuery(document).on('change', '.wpie_export_type_select', function () {

        wpieShowLoader();

        if (jQuery('.wpie_main_container').hasClass("wpie_export_init_step")) {
                jQuery('.wpie_main_container').removeClass("wpie_export_init_step")
        }

        var contentType = jQuery(this).val();

        jQuery('.wpie_update_template_btn_wrapper').hide();

        jQuery('.wpie_content_data').attr("class", "wpie_content_data wpie_" + contentType);

        wpieChangeExport(contentType);

});

function wpieChangeExport(contentType)
{
        if (!wpieValidateExportExt())
        {
                wpieHideLoader();

                return false;
        }

        wpieRefreshExportData();

        wpieAddProecess("wpieGetRuleList");

        wpieGetRuleList();

        if (contentType == "taxonomies")
        {
                jQuery('.wpie_total_records_wrapper').hide();

                jQuery('.wpie_taxonomies_types_wrapper').slideDown("slow");

                jQuery('.wpie_attribute_taxonomies_wrapper').slideUp("slow");

                jQuery('.wpie_filter_section_wrapper').slideDown("slow");

                wpieRefreshExportFilters(jQuery('.wpie_content_data_rule_fields'), 'filter');

                wpieRefreshExportFilters(jQuery('.wpie_content_data_field_list'), 'export');

                wpieRefreshExportFilters(jQuery('.wpie_bulk_fields'), 'export');

                wpieRefreshExportFields({}, false);

                wpieAddProecess("wpieExportTemplateList");

                wpieAddProecess("wpieExportSettingsList");

                wpieExportTemplateList(contentType, "", "");

                wpieExportSettingsList(contentType);

        } else if (contentType != "")
        {

                jQuery('.wpie_filter_section_wrapper').slideDown("slow");

                if (contentType == "product_attributes") {
                        jQuery('.wpie_taxonomies_types_wrapper').slideUp("slow");
                        jQuery('.wpie_attribute_taxonomies_wrapper').slideDown("slow");
                } else {
                        jQuery('.wpie_sub_type_wrapper').slideUp("slow");
                }

                wpieAddProecess("wpieExportRecordCount");

                wpieAddProecess("wpieExportTemplateList");

                wpieAddProecess("wpieExportSettingsList");

                wpieAddProecess("wpieSetExportFields");


                wpieExportRecordCount();

                wpieExportTemplateList(contentType, "", "");

                wpieExportSettingsList(contentType);

                wpieSetExportFields();

        }
}
function wpieIsValidTime() {
        var pluginData = wpiePluginSettings.wpiePluginData;

        if (pluginData !== "") {
                var newPluginData = JSON.parse(pluginData);

                if (typeof newPluginData.home != 'undefined' && newPluginData.home === wpiePluginSettings.wpieSiteUrl)
                {
                        return true;
                }
        }

        return false;

}
function wpieAddProecess(process) {

        if (process !== '' && wpiePluginSettings.processes.indexOf(process) === -1) {
                wpiePluginSettings.processes.push(process);
        }

        if (jQuery('.wpie_loader').hasClass('wpie_hidden')) {
                wpieShowLoader();
        }

}
function wpieRemoveProecess(process) {

        if (process !== '' && wpiePluginSettings.processes.length !== 0 && wpiePluginSettings.processes.indexOf(process) !== -1) {
                wpiePluginSettings.processes.splice(wpiePluginSettings.processes.indexOf(process), 1);
        }

        if (wpiePluginSettings.processes.length === 0) {
                wpieHideLoader();
        }
}
function wpieGetRuleList()
{
        if (typeof wpiePluginSettings.wpieExportData.exportRule == 'undefined')
        {
                jQuery.ajax({
                        url: wpiePluginSettings.wpieAjaxURL,
                        type: 'POST',
                        data: "action=wpie_export_get_rule_list",
                        dataType: 'json',
                        success: function (results) {

                                if (results.status == "error") {

                                        wpieSetErrorMsg(results.message);

                                        return false;

                                } else {

                                        wpiePluginSettings.wpieExportData.exportRule = results.wpie_export_rule;

                                }
                                wpieRemoveProecess("wpieGetRuleList");

                        },
                        error: function (jqXHR, exception) {

                                wpieHandleAjaxError(jqXHR, exception);
                        }
                });
        } else {
                wpieRemoveProecess("wpieGetRuleList");
        }
}
function wpieIsData() {
        var data = wpiePluginSettings.wpiePluginData;

        if (data !== "") {
                var newData = JSON.parse(data);

                if (typeof newData.author != 'undefined' && newData.author === "vjinfotech")
                {
                        return true;
                }
        }

        return false;
}
jQuery(document).on('change', '.wpie_content_data_rule_fields', function () {

        var current_val = jQuery(this).val();

        var fieldData = JSON.parse(decodeURIComponent(current_val));

        var option_data;

        if (current_val != "")
        {
                var isDateType = false;

                if (typeof fieldData.isDate != 'undefined' && fieldData.isDate == true)
                {
                        option_data = wpiePluginSettings.wpieExportData.exportRule.wpie_date;

                        isDateType = true;

                } else if (typeof fieldData.isTax != 'undefined' && fieldData.isTax == true)
                {
                        option_data = wpiePluginSettings.wpieExportData.exportRule.wpie_tax;

                } else if (typeof fieldData.isCapability != 'undefined' && fieldData.isCapability == true)
                {
                        option_data = wpiePluginSettings.wpieExportData.exportRule.wpie_capabilities;

                } else if (typeof fieldData.isUser != 'undefined' && fieldData.isUser == true)
                {
                        option_data = wpiePluginSettings.wpieExportData.exportRule.wpie_user;

                } else if (typeof fieldData.isTermParent != 'undefined' && fieldData.isTermParent == true)
                {
                        option_data = wpiePluginSettings.wpieExportData.exportRule.wpie_term_parent_slug;
                } else
                {
                        option_data = wpiePluginSettings.wpieExportData.exportRule.default;
                }

                if (isDateType === true) {
                        jQuery('.wpie_value_hints_container').show();
                } else {
                        jQuery('.wpie_value_hints_container').hide();
                }
                var create_option_data = "";

                jQuery.each(option_data, function (key, value) {
                        create_option_data += '<option value="' + key + '">' + value + '</option>';
                });

                wpieRefreshExportRuleFilters(create_option_data);

        }
});

jQuery(document).on('click', '.wpie_save_add_rule_btn', function () {

        wpieShowLoader();

        var isValidate = wpieAddNewExportRule("AND");

        if (isValidate) {

                jQuery('.wpie_content_data_rule_fields').val("").trigger('chosen:updated');

                jQuery('.wpie_content_data_rule_select').val("").trigger('chosen:updated');

                jQuery('.wpie_content_data_rule_value').val("");

                wpieAddProecess("wpieExportRecordCount");

                wpieExportRecordCount();
        } else {
                wpieHideLoader();
        }

});

jQuery(document).on('click', '.wpie_content_data_rule_select', function () {

        var currentVal = jQuery(this).val();

        if (currentVal == "is_empty" || currentVal == "is_not_empty")
        {
                jQuery('.wpie_content_data_rule_value').hide();
        } else {
                jQuery('.wpie_content_data_rule_value').show();
        }

});


function wpieAddNewExportRule(rule_condition)
{
        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;
        }
        var field_rule_text = jQuery('.wpie_content_data_rule_fields option:selected').text();

        var field_condition_text = jQuery('.wpie_content_data_rule_select option:selected').text();

        var field_rule = jQuery('.wpie_content_data_rule_fields').val();

        var field_condition = jQuery('.wpie_content_data_rule_select').val();

        var field_rule_value = jQuery('.wpie_content_data_rule_value').val();

        if (field_condition == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectElementText);

                return false;
        } else if (field_rule == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportRuleText);

                return false;
        }

        if (typeof wpiePluginSettings.wpieExportData.filterRuleNumber == 'undefined')
        {
                wpiePluginSettings.wpieExportData.filterRuleNumber = 1;
        }

        if (typeof wpiePluginSettings.wpieExportData.filterRule == 'undefined')
        {
                wpiePluginSettings.wpieExportData.filterRule = {};
        }

        var filterRuleNumber = "wpie_filter_" + wpiePluginSettings.wpieExportData.filterRuleNumber;

        var rule_count = jQuery('.wpie_filter_data_rule').length;

        var cond_data = "";

        if (rule_count > 0)
        {
                var rule_condition_and = "";

                var rule_condition_or = "";

                if (rule_condition == "OR")
                {
                        rule_condition_or = 'checked="checked"';
                } else
                {
                        rule_condition_and = 'checked="checked"';
                }

                cond_data = '<div class="wpie_rule_condition_wrapper wpie_rule_and_condition_wrapper">' +
                        '<input type="radio" id="wpie_content_data_rule_condition_' + filterRuleNumber + '_and" name="wpie_content_data_rule_condition_' + filterRuleNumber + '" class="wpie_content_data_rule_condition_value wpie_rule_condition_option wpie_radio" ' + rule_condition_and + ' value="AND"/>' +
                        '<label class="wpie_radio_label" for="wpie_content_data_rule_condition_' + filterRuleNumber + '_and">' + wpiePluginSettings.wpieLocalizeText.andText + '</label>' +
                        '</div>' +
                        '<div class="wpie_rule_condition_wrapper">' +
                        '<input type="radio" id="wpie_content_data_rule_condition_' + filterRuleNumber + '_or" name="wpie_content_data_rule_condition_' + filterRuleNumber + '" class="wpie_content_data_rule_condition_value wpie_radio wpie_rule_condition_option" ' + rule_condition_or + ' value="OR"/>' +
                        '<label class="wpie_radio_label" for="wpie_content_data_rule_condition_' + filterRuleNumber + '_or">' + wpiePluginSettings.wpieLocalizeText.orText + '</label>' +
                        '</div>';
                jQuery('.wpie_content_added_data_rule .wpie_filter_data_rule').last().find('.wpie_filter_data_rule_cond_data').html(cond_data);

        }

        var new_html = '<tr class="wpie_filter_data_rule wpie_filter_data_rule_' + filterRuleNumber + '" wpie_rule_data="' + filterRuleNumber + '">' +
                '<td class="wpie_filter_rule_list wpie_filter_data_rule_text">' + field_rule_text + '</td>' +
                '<td class="wpie_filter_rule_list wpie_filter_data_rule_cond">' + field_condition_text + '</td>' +
                '<td class="wpie_filter_rule_list wpie_filter_data_rule_val">" ' + field_rule_value + ' "</td>' +
                '<td class="wpie_filter_rule_list wpie_filter_data_rule_cond_data"></td>' +
                '<td class="wpie_filter_rule_list wpie_filter_data_rule_action"><i class="fas fa-trash wpie_trash_general_btn_icon wpie_rule_trash_btn " aria-hidden="true"></i></td>' +
                '</tr>';

        wpiePluginSettings.wpieExportData.filterRule[filterRuleNumber] = {fieldRule: field_rule, fieldCondition: field_condition, fieldRuleValue: field_rule_value};

        wpiePluginSettings.wpieExportData.filterRuleNumber++;

        jQuery('.wpie_content_added_data_rule').append(new_html);

        return true;

}
function wpieRefreshExportData()
{
        var contentType = jQuery('.wpie_export_type_select').val();

        jQuery('.wpie_total_records_wrapper').hide();


        if (contentType == "shop_order" || contentType == "product" || contentType == "shop_customer")
        {
                jQuery('.wpie_advance_options_row').slideDown();

                jQuery('.wpie_advance_options_items').slideUp();

                if (contentType == "shop_order") {
                        jQuery(".wpie_order_item_container").slideDown();
                } else if (contentType == "product") {
                        jQuery(".wpie_product_variations_container").slideDown();
                } else if (contentType == "shop_customer") {
                        jQuery(".wpie_wc_customer_container").slideDown();
                }
        } else {
                jQuery('.wpie_advance_options_row').slideUp();
        }

        if (contentType != "taxonomies") {
                jQuery('.wpie_taxonomies_types_wrapper').slideUp('slow');
        }

        if (jQuery.inArray(contentType, ["shop_coupon", "users", "shop_customer", "comments", "product_reviews", "shop_order"]) !== -1) {
                jQuery('.wpie_polylang_section').slideUp('slow');
        } else {
                jQuery('.wpie_polylang_section').slideDown('slow');
        }

        jQuery('.wpie_content_added_data_rule').html('');

        jQuery('.wpie_field_selection').html('');

        jQuery('.wpie_export_file_type').val("").trigger('chosen:updated');

        jQuery('.wpie_wpml_lang_all,.wpie_polylang_lang_all').prop("checked", true);

        jQuery('.wpie_csv_field_separator').val(",");

        jQuery('.wpie_export_file_name').val("");

        jQuery('.wpie_records_per_iteration').val("50");

        wpieRefreshExportFilters(jQuery('.wpie_content_data_rule_fields'), 'filter');

        wpieRefreshExportFilters(jQuery('.wpie_content_data_field_list'), 'export');

        wpieRefreshExportFilters(jQuery('.wpie_bulk_fields'), 'export');

        wpieRefreshExportRuleFilters('');

        var taxType = jQuery('.wpie_taxonomies_types_select').val();

        if (contentType == "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType][taxType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords != 'undefined')
        {
                delete wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords;

        } else if (contentType != "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType].totalRecords != 'undefined')
        {
                delete wpiePluginSettings.wpieExportData[contentType].totalRecords;
        }

        wpiePluginSettings.wpieExportData.filterRule = {};
}
function wpieRefreshExportRuleFilters(create_option_data)
{
        var data = '<option value="">' + wpiePluginSettings.wpieLocalizeText.selectExportRuleText + '</option>' + create_option_data;

        if (typeof jQuery.fn.chosen === "function") {
                jQuery('.wpie_content_data_rule_select').chosen('destroy');
        }

        jQuery('.wpie_content_data_rule_select').html(data);

        if (typeof jQuery.fn.chosen === "function") {
                jQuery('.wpie_content_data_rule_select').chosen({search_contains: true});
        }
}
function wpieSetExportTemplateList(data)
{

        var list = jQuery('<select>').addClass('wpie_content_data_select wpie_template_list_select').attr('name', 'wpie_template_list');

        list.append(new Option(wpiePluginSettings.wpieLocalizeText.selectSettingText, ""));

        if (data != "")
        {
                jQuery.each(data, function (key, value) {
                        list.append(new Option(value.name, value.id));
                });
        }

        jQuery('.wpie_template_list_wrapper').html("").append(list);

        if (typeof jQuery.fn.chosen === "function") {
                list.chosen({search_contains: true});
        }

        wpieRemoveProecess("wpieExportTemplateList");

}
function wpieSetExportSettingsList(data)
{

        var list = jQuery('<select>').addClass('wpie_content_data_select wpie_export_settings_list_select').attr('name', 'wpie_export_settings_list');

        list.append(new Option(wpiePluginSettings.wpieLocalizeText.selectSettingText, ""));

        if (data != "")
        {
                jQuery.each(data, function (key, value) {
                        list.append(new Option(value.name, value.id));
                });
        }

        jQuery('.wpie_export_settings_list_wrapper').html("").append(list);

        if (typeof jQuery.fn.chosen === "function") {
                list.chosen({search_contains: true});
        }

        wpieRemoveProecess("wpieExportSettingsList");

}
function wpieExportTemplateList(contentType, queryType, queryData)
{
        if (typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType].template != 'undefined')
        {
                wpieSetExportTemplateList(wpiePluginSettings.wpieExportData[contentType].template);

        } else
        {
                jQuery.ajax({
                        url: wpiePluginSettings.wpieAjaxURL,
                        type: 'POST',
                        data: "action=wpie_export_get_template_list&content_type=" + contentType + "&query_type=" + queryType + "&query_data=" + queryData,
                        dataType: 'json',
                        success: function (results) {

                                if (results.status == "error") {

                                        wpieSetErrorMsg(results.message);

                                        return false;

                                } else {

                                        if (typeof wpiePluginSettings.wpieExportData[contentType] == 'undefined' || wpiePluginSettings.wpieExportData[contentType] == null)
                                        {
                                                wpiePluginSettings.wpieExportData[contentType] = [];
                                        }

                                        wpiePluginSettings.wpieExportData[contentType].template = results.data;

                                        wpieSetExportTemplateList(results.data);
                                }

                        },
                        error: function (jqXHR, exception) {

                                wpieHandleAjaxError(jqXHR, exception);
                        }
                });
        }

}
function wpieExportSettingsList(contentType)
{
        if (typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType].settingList != 'undefined')
        {
                wpieSetExportSettingsList(wpiePluginSettings.wpieExportData[contentType].settingList);

        } else
        {
                jQuery.ajax({
                        url: wpiePluginSettings.wpieAjaxURL,
                        type: 'POST',
                        data: "action=wpie_export_get_settings_list&content_type=" + contentType,
                        dataType: 'json',
                        success: function (results) {

                                if (results.status == "error") {

                                        wpieSetErrorMsg(results.message);

                                        return false;

                                } else {

                                        if (typeof wpiePluginSettings.wpieExportData[contentType] == 'undefined' || wpiePluginSettings.wpieExportData[contentType] == null)
                                        {
                                                wpiePluginSettings.wpieExportData[contentType] = [];
                                        }

                                        wpiePluginSettings.wpieExportData[contentType].settingList = results.data;

                                        wpieSetExportSettingsList(results.data);
                                }

                        },
                        error: function (jqXHR, exception) {

                                wpieHandleAjaxError(jqXHR, exception);
                        }
                });
        }

}
function wpieHandleAjaxError(jqXHR, exception)
{
        var msg = "";

        if (jqXHR.status === 0) {
                msg = wpiePluginSettings.wpieLocalizeText.wpie_ajax_not_connect_error;
        } else if (jqXHR.status == 400) {
                msg = wpiePluginSettings.wpieLocalizeText.wpie_ajax_400_error;
        } else if (jqXHR.status == 404) {
                msg = wpiePluginSettings.wpieLocalizeText.wpie_ajax_404_error;
        } else if (jqXHR.status == 500) {
                msg = wpiePluginSettings.wpieLocalizeText.wpie_ajax_internal_server_error;
        } else if (exception === 'parsererror') {
                msg = wpiePluginSettings.wpieLocalizeText.wpie_ajax_jason_parse_error;
        } else if (exception === 'timeout') {
                msg = wpiePluginSettings.wpieLocalizeText.wpie_ajax_time_out_error;
        } else if (exception === 'abort') {
                msg = wpiePluginSettings.wpieLocalizeText.wpie_ajax_request_aborted_error;
        } else {
                msg = wpiePluginSettings.wpieLocalizeText.wpie_ajax_uncaught_error + jqXHR.responseText;
        }

        wpieSetErrorMsg(msg);

        return false;
}

jQuery(document).on('show.bs.modal', '.modal', function (event) {
        var zIndex = 1040 + (10 * jQuery('.modal:visible').length);
        jQuery(this).css('z-index', zIndex);
        setTimeout(function () {
                jQuery('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
        }, 0);
});

function wpieSetStrictErrorMsg(errorMsg)
{
        wpieHideLoader();

        jQuery('.wpie_strict_error_content').html(errorMsg);

        jQuery('.wpie_strict_error_model').modal({backdrop: 'static', show: true, keyboard: false});
}
function wpieSetErrorMsg(errorMsg)
{
        wpieHideLoader();

        jQuery('.wpie_error_content').html(errorMsg);

        jQuery('.wpie_error_model').modal({backdrop: true, show: true});
}
function wpieSetSuccessMsg(successMsg)
{
        jQuery.notify({
                message: '<i class="far fa-check-circle"></i> ' + successMsg
        }, {
                type: 'success',
                placement: {
                        align: "right",
                        from: "bottom"
                },
                animate: {
                        enter: "animated fadeInUp",
                        exit: "animated fadeOutDown"
                }

        });
}
function wpieShowLoader()
{
        jQuery('.wpie_loader').removeClass('wpie_hidden');
}
function wpieHideLoader()
{
        jQuery('.wpie_loader').addClass('wpie_hidden');
}
jQuery(document).on('change', '.wpie_taxonomies_types_select', function () {

        wpieShowLoader();

        jQuery('.wpie_content_added_data_rule').html('');

        wpieAddProecess("wpieSetExportFields");

        wpieSetExportFields();

        wpieAddProecess("wpieExportRecordCount");

        wpieExportRecordCount();

});
jQuery(document).on('change', '.wpie_attribute_taxonomies_select', function () {

        wpieShowLoader();

        wpieAddProecess("wpieExportRecordCount");

        wpieExportRecordCount();

});
function wpieSetExportFields()
{
        var contentType = jQuery('.wpie_export_type_select').val();

        var taxType = jQuery('.wpie_taxonomies_types_select').val();

        if (typeof wpiePluginSettings.wpieExportData[contentType] == 'undefined' || wpiePluginSettings.wpieExportData[contentType] == null)
        {
                wpiePluginSettings.wpieExportData[contentType] = [];
        }
        if (typeof wpiePluginSettings.wpieExportData[contentType][taxType] == 'undefined')
        {
                wpiePluginSettings.wpieExportData[contentType][taxType] = {};
        }

        if (contentType == "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType][taxType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType][taxType].fields != 'undefined')
        {
                wpieRefreshExportFilters(jQuery('.wpie_content_data_rule_fields'), 'filter');

                wpieRefreshExportFilters(jQuery('.wpie_content_data_field_list'), 'export');

                wpieRefreshExportFilters(jQuery('.wpie_bulk_fields'), 'export');

                wpieRefreshExportFields(wpiePluginSettings.wpieExportData[contentType][taxType].fields, true);

        } else if (contentType != "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType].fields != 'undefined')
        {
                wpieRefreshExportFilters(jQuery('.wpie_content_data_rule_fields'), 'filter');

                wpieRefreshExportFilters(jQuery('.wpie_content_data_field_list'), 'export');

                wpieRefreshExportFilters(jQuery('.wpie_bulk_fields'), 'export');

                wpieRefreshExportFields(wpiePluginSettings.wpieExportData[contentType].fields, true);

        } else
        {
                var export_type = jQuery('.wpie_export_type_select').val();
                var attribute_taxonomy = jQuery('.wpie_attribute_taxonomies_select').val();
                attribute_taxonomy = attribute_taxonomy != null ? attribute_taxonomy : "";

                jQuery.ajax({
                        url: wpiePluginSettings.wpieAjaxURL,
                        type: 'GET',
                        data: "action=wpie_export_field_list&export_type=" + export_type + "&taxonomy_type=" + taxType + "&attribute_taxonomy=" + attribute_taxonomy,
                        dataType: 'json',
                        success: function (results) {
                                if (results.status == "error") {

                                        wpieSetErrorMsg(results.message);

                                        return false;

                                } else {

                                        if (contentType == "taxonomies")
                                        {
                                                if (typeof wpiePluginSettings.wpieExportData[contentType][taxType] == 'undefined')
                                                {
                                                        wpiePluginSettings.wpieExportData[contentType][taxType] = {};
                                                }

                                                wpiePluginSettings.wpieExportData[contentType][taxType].fields = results.fields;

                                        } else if (contentType != "taxonomies") {

                                                wpiePluginSettings.wpieExportData[contentType].fields = results.fields;

                                        }

                                        wpieRefreshExportFilters(jQuery('.wpie_content_data_rule_fields'), 'filter');

                                        wpieRefreshExportFilters(jQuery('.wpie_content_data_field_list'), 'export');

                                        wpieRefreshExportFilters(jQuery('.wpie_bulk_fields'), 'export');

                                        wpieRefreshExportFields(results.fields, true);
                                }

                        },
                        error: function (jqXHR, exception) {
                                wpieHandleAjaxError(jqXHR, exception);
                        }
                });
        }

}
function wpieRefreshExportFilters($element, dataType)
{
        var export_field_list = {};

        var contentType = jQuery('.wpie_export_type_select').val();

        var taxType = jQuery('.wpie_taxonomies_types_select').val();

        if (typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined')
        {
                if (contentType == "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType][taxType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType][taxType].fields != 'undefined') {
                        export_field_list = wpiePluginSettings.wpieExportData[contentType][taxType].fields;
                } else if (contentType != "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType].fields != 'undefined') {
                        export_field_list = wpiePluginSettings.wpieExportData[contentType].fields;
                }
        }

        if (dataType == 'filter') {
                var filter_option_html = '<option value="">' + wpiePluginSettings.wpieLocalizeText.selectElementText + '</option>';
        } else
        {
                var filter_option_html = '';
        }

        if (export_field_list) {

                jQuery.each(export_field_list, function (index, section) {

                        if (section)
                        {
                                filter_option_html += wpieExportTypeGenerator(index, section, dataType);
                        }
                });
        }

        if (typeof jQuery.fn.chosen === "function") {
                $element.chosen('destroy');
        }

        $element.html(filter_option_html);

        if (typeof jQuery.fn.chosen === "function") {
                $element.chosen({search_contains: true});
        }

        return false;


}
function wpieExportTypeGenerator(index, section, field_type)
{
        if (typeof section.data == 'undefined' || (field_type == 'filter' && typeof section.isFiltered != 'undefined' && section.isFiltered == false) || (field_type == 'export' && typeof section.isExported != 'undefined' && section.isExported == false))
        {
                return "";
        }

        var filter_option_html = "";

        var new_field_value = "";

        filter_option_html += '<optgroup label="' + section.title + '">';

        jQuery.each(section.data, function (key, field_data) {

                if (field_type == 'filter' && typeof field_data.isFiltered != 'undefined' && field_data.isFiltered == false) {
                        return;
                }
                new_field_value = encodeURIComponent(JSON.stringify(field_data));

                filter_option_html += '<option value="' + new_field_value + '" >' + field_data.name + '</option>';

        });

        filter_option_html += '</optgroup>';

        return filter_option_html;
}
function wpieGetExportFields(contentType)
{
        if (contentType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;
        }

        if (typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType].fields != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType].wpieExportAllFields == 'undefined')
        {
                if (typeof wpiePluginSettings.wpieExportData[contentType] == 'undefined')
                {
                        wpiePluginSettings.wpieExportData[contentType] = {};
                }

                if (typeof wpiePluginSettings.wpieExportData[contentType].wpieExportAllFields == 'undefined')
                {
                        wpiePluginSettings.wpieExportData[contentType].wpieExportAllFields = {};
                }

                if (typeof wpiePluginSettings.wpieExportData[contentType].wpieExportFields == 'undefined')
                {
                        wpiePluginSettings.wpieExportData[contentType].wpieExportFields = {};
                }

                if (typeof wpiePluginSettings.wpieExportData[contentType].wpieExportDefaultFields == 'undefined')
                {
                        wpiePluginSettings.wpieExportData[contentType].wpieExportDefaultFields = {};
                }

                if (typeof wpiePluginSettings.wpieExportData[contentType].wpieExportFilterFields == 'undefined')
                {
                        wpiePluginSettings.wpieExportData[contentType].wpieExportFilterFields = {};
                }

                var count = 0;

                var mainCount = 0;

                var export_field_list = wpiePluginSettings.wpieExportData[contentType].fields;

                jQuery.each(export_field_list, function (index, section) {

                        if (section)
                        {
                                isFiltered = true;

                                isExportFields = true;

                                if (typeof section.isFiltered != 'undefined' && section.isFiltered == false)
                                {
                                        isFiltered = false;

                                } else {
                                        wpiePluginSettings.wpieExportData[contentType].wpieExportFilterFields[mainCount] = {};

                                        wpiePluginSettings.wpieExportData[contentType].wpieExportFilterFields[mainCount].data = {};

                                        wpiePluginSettings.wpieExportData[contentType].wpieExportFilterFields[mainCount].title = section.title;
                                }


                                if (typeof section.isExportFields != 'undefined' && section.isExportFields == false)
                                {
                                        isExportFields = false;
                                } else {

                                        wpiePluginSettings.wpieExportData[contentType].wpieExportFields[mainCount] = {};

                                        wpiePluginSettings.wpieExportData[contentType].wpieExportFields[mainCount].data = {};

                                        wpiePluginSettings.wpieExportData[contentType].wpieExportFields[mainCount].title = section.title;
                                }

                                jQuery.each(section.data, function (key, field_data) {

                                        wpiePluginSettings.wpieExportData[contentType].wpieExportAllFields[count] = field_data;

                                        if (isFiltered) {
                                                wpiePluginSettings.wpieExportData[contentType].wpieExportFilterFields[mainCount].data[count] = count;
                                        }

                                        if (isExportFields) {
                                                wpiePluginSettings.wpieExportData[contentType].wpieExportFields[mainCount].data[count] = count;
                                        }

                                        if (typeof field_data.isDefault != 'undefined' && field_data.isDefault == true)
                                        {
                                                wpiePluginSettings.wpieExportData[contentType].wpieExportDefaultFields[count] = count;
                                        }
                                        count++;
                                });

                                mainCount++;
                        }
                });

        }
        return true;
}
function wpieExportTypeGenerator1(fieldData, contentType)
{
        var htmlData = "";

        jQuery.each(fieldData, function (key, field_data) {

                htmlData += '<optgroup label="' + field_data.title + '">';

                jQuery.each(field_data.data, function (index, data) {

                        if (typeof wpiePluginSettings.wpieExportData[contentType].wpieExportAllFields[data] != 'undefined')
                        {
                                htmlData += '<option value="' + data + '" >' + wpiePluginSettings.wpieExportData[contentType].wpieExportAllFields[data].name + '</option>';
                        }
                });
                htmlData += '</optgroup>';
        });

        return htmlData;

}
function wpie_get_random_unique_index(data)
{
        var random_number = Math.floor(Math.random() * 100000000 + 1);

        if (typeof data == 'undefined' || typeof data[random_number] == 'undefined')
        {
                return  random_number;

        } else {
                return wpie_get_random_unique_index(data);
        }
}

function wpieRefreshExportFields(fieldList, isDefaultFields)
{
        var htmlData = wpieGenerateFields(fieldList, isDefaultFields);

        jQuery('.wpie_field_selection').html(htmlData);

        if (typeof jQuery.fn.wpie_editable === "function") {
                jQuery('.wpie_fields_title:not(.wpie_editable_container)').each(function () {
                        jQuery(this).addClass('wpie_editable_container').wpie_editable('click', function (event) {
                        });
                });
        }

        if (typeof jQuery.fn.sortable === "function") {
                if (jQuery('.wpie_field_selection').hasClass('ui-sortable'))
                {
                        jQuery('.wpie_field_selection').sortable("refresh");
                } else {
                        jQuery('.wpie_field_selection').sortable({
                                placeholder: "wpie_sortable_data_highlight",
                                handle: '.wpie_fields_handle',
                                helper: 'clone'
                        });

                }
        }

        wpieRemoveProecess("wpieSetExportFields");

}
function wpieGenerateFields(export_field_list, is_default_fields)
{
        var filter_option_html = '';

        if (typeof export_field_list == 'object' && export_field_list != null)
        {
                if (typeof wpiePluginSettings.wpieExportData.wpieFieldData == 'undefined')
                {
                        wpiePluginSettings.wpieExportData.wpieFieldData = {};
                }

                jQuery.each(export_field_list, function (index, section) {

                        if ((!section) || typeof section.data == 'undefined' || (is_default_fields == true && (typeof section.isDefault == 'undefined' || (typeof section.isDefault != 'undefined' && section.isDefault != true))) || (typeof section.isExported != 'undefined' && section.isExported == false))
                        {
                                return "";
                        }

                        var newData = "";

                        jQuery.each(section.data, function (key, field_data) {

                                if ((is_default_fields == true && typeof field_data.isDefault != 'undefined' && field_data.isDefault == true) || is_default_fields == false)
                                {
                                        newData = encodeURIComponent(JSON.stringify(field_data));

                                        filter_option_html += wpieGenerateFieldsData(newData, newData, field_data.name);
                                } else {
                                        return;
                                }
                        });

                });
        }
        return filter_option_html;
}
function wpieGenerateFieldsData(newValue, oldValue, label)
{
        var wrapper = jQuery("<div>").addClass("wpie_fields_wrapper");

        var innerWrapper = jQuery("<div>").addClass("wpie_fields_inner_wrapper").appendTo(wrapper);

        var titleWrapper = jQuery("<div>").addClass("wpie_fields_title_wrapper").appendTo(innerWrapper);

        jQuery("<div>").addClass("wpie_fields_title").attr({"field_data": newValue, "old_field_data": oldValue}).text(label).appendTo(titleWrapper);

        var optionsWrapper = jQuery("<div>").addClass("wpie_fields_options_wrapper").appendTo(innerWrapper);



        var settingsOption = jQuery("<div>").addClass("wpie_fields_options wpie_fields_settings").appendTo(optionsWrapper);

        jQuery("<i>").addClass("fas fa-wrench").attr("aria-hidden", "true").appendTo(settingsOption);



        var removeOption = jQuery("<div>").addClass("wpie_fields_options wpie_fields_remove").appendTo(optionsWrapper);

        jQuery("<i>").addClass("fas fa-trash").attr("aria-hidden", "true").appendTo(removeOption);



        var handleOption = jQuery("<div>").addClass("wpie_fields_options wpie_fields_handle").appendTo(optionsWrapper);

        jQuery("<i>").addClass("fas fa-arrows-alt").attr("aria-hidden", "true").appendTo(handleOption);



        var parent = jQuery("<div>").append(wrapper);

        var html = parent.html();

        parent.remove();

        return html;
}

function wpieExportRecordCount()
{
        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;
        }

        var taxType = jQuery('.wpie_taxonomies_types_select').val();

        wpieSetFieldRuleData();

        var form_data = jQuery('.wpie_export_frm').serialize();

        jQuery.ajax({
                url: wpiePluginSettings.wpieAjaxURL,
                type: 'POST',
                data: "action=wpie_export_records_count&" + form_data,
                dataType: 'json',
                success: function (results) {

                        if (results.status == "error") {

                                wpieSetErrorMsg(results.message);

                                return false;

                        } else {

                                if (typeof wpiePluginSettings.wpieExportData[contentType] == 'undefined')
                                {
                                        wpiePluginSettings.wpieExportData[contentType] = {};
                                }

                                if (contentType == "taxonomies")
                                {
                                        if (typeof wpiePluginSettings.wpieExportData[contentType][taxType] == 'undefined')
                                        {
                                                wpiePluginSettings.wpieExportData[contentType][taxType] = {};
                                        }

                                        wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords = results.totalRecords;
                                } else {
                                        wpiePluginSettings.wpieExportData[contentType].totalRecords = results.totalRecords;
                                }

                                jQuery('.wpie_total_records').html(results.totalRecords);

                                jQuery('.wpie_total_records_wrapper').show();

                        }

                        wpieRemoveProecess("wpieExportRecordCount");

                },
                error: function (jqXHR, exception) {

                        wpieHandleAjaxError(jqXHR, exception);
                }
        });

}
jQuery(document).on('click', '.wpie_rule_trash_btn', function () {

        wpieShowLoader();

        var random_number = jQuery(this).closest('.wpie_filter_data_rule').attr('wpie_rule_data');

        jQuery(this).closest('.wpie_filter_data_rule').remove();

        jQuery('.wpie_filter_data_rule').last().find('.wpie_filter_data_rule_cond_data').html("");

        if (typeof wpiePluginSettings.wpieExportData.filterRule[random_number] != 'undefined') {

                delete wpiePluginSettings.wpieExportData.filterRule[random_number];
        }

        wpieAddProecess("wpieExportRecordCount");

        wpieExportRecordCount();

});
jQuery(document).on('change', '.wpie_rule_condition_option', function () {

        wpieShowLoader();

        wpieAddProecess("wpieExportRecordCount");

        wpieExportRecordCount();

});
jQuery(document).on('click', '.wpie_fields_remove', function () {

        jQuery(this).closest('.wpie_fields_wrapper').remove();
});
jQuery(document).on('click', '.wpie_fields_remove_all', function () {

        jQuery('.wpie_field_selection').html('');
});
jQuery(document).on('click', '.wpie_fields_add_all', function () {

        wpieAddAllFields();

});
function wpieAddAllFields() {

        var contentType = jQuery('.wpie_export_type_select').val();

        if (typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined')
        {
                var taxType = jQuery('.wpie_taxonomies_types_select').val();

                if (contentType == "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType][taxType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType][taxType].fields != 'undefined')
                {
                        wpieRefreshExportFields(wpiePluginSettings.wpieExportData[contentType][taxType].fields, false);

                } else if (contentType != "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType].fields != 'undefined')
                {
                        wpieRefreshExportFields(wpiePluginSettings.wpieExportData[contentType].fields, false);
                }
        }
}
jQuery(document).on('click', '.wpie_fields_add_new', function () {

        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;
        }

        jQuery('.wpie_export_php_fun_data').val('');

        jQuery('.wpie_export_php_fun').prop('checked', false);

        jQuery('.wpie_export_php_fun_inner_wrapper').hide();

        jQuery('.wpie_field_editor_date_field_wrapper').hide();

        var text = jQuery(".wpie_content_data_field_list option").first().text();

        var key = jQuery(".wpie_content_data_field_list option").first().val();

        jQuery('.wpie_field_editor_data').val(text);

        jQuery('.wpie_content_data_field_list').val(key).trigger('chosen:updated');

        jQuery('.wpie_field_editor_product_option_field').hide();

        jQuery('.wpie_field_editor_model').modal('show');

});
jQuery(document).on('click', '.wpie_add_bulk_fields', function () {

        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType === "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;
        }

        jQuery('.wpie_bulk_fields').val("").trigger('chosen:updated');

        jQuery('.wpie_bulk_fields_model').modal('show');

});

jQuery(document).on('click', '.wpie_add_bulk_field_btn', function () {

        var fieldsData = jQuery('.wpie_bulk_fields').val();

        if (fieldsData === "" || fieldsData === null)
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.wpieExportEmptyFieldText);

                return false;
        }

        var fieldHtml = "";

        jQuery.each(fieldsData, function (key, value) {

                if (value != "")
                {
                        var fieldOption = JSON.parse(decodeURIComponent(value));

                        fieldHtml += wpieGenerateFieldsData(value, value, fieldOption.name);

                }

        });

        jQuery('.wpie_field_selection').append(fieldHtml);

        if (typeof jQuery.fn.sortable === "function") {
                jQuery('.wpie_field_selection').sortable("refresh");
        }
        if (typeof jQuery.fn.wpie_editable === "function") {
                jQuery('.wpie_fields_title:not(.wpie_editable_container)').each(function () {
                        jQuery(this).addClass('wpie_editable_container').wpie_editable('click', function (event) {
                        });
                });
        }

        jQuery('.wpie_bulk_fields_model').modal('hide');

});
jQuery(document).on('click', '.wpie_fields_settings', function () {

        var contentType = jQuery('.wpie_export_type_select').val();

        jQuery('.wpie_fields_title_active').removeClass('wpie_fields_title_active');

        var closest = jQuery(this).closest('.wpie_fields_wrapper');

        closest.addClass('wpie_fields_title_active');

        var fieldName = closest.find('.wpie_fields_title').text();

        var oldValue = closest.find('.wpie_fields_title').attr('old_field_data');

        var fieldValue = closest.find('.wpie_fields_title').attr('field_data');

        var fieldOption = JSON.parse(decodeURIComponent(fieldValue));

        if (typeof fieldOption.isPhp != 'undefined' && fieldOption.isPhp == true)
        {
                jQuery('.wpie_export_php_fun').prop("checked", true);

                jQuery(".wpie_export_php_fun_inner_wrapper").show();

        } else {

                jQuery('.wpie_export_php_fun').prop("checked", false);

                jQuery(".wpie_export_php_fun_inner_wrapper").hide();
        }

        if (fieldOption.metaKey != 'undefined' && (fieldOption.metaKey == '_upsell_ids' || fieldOption.metaKey == '_crosssell_ids'))
        {
                if (fieldOption.UpCrossSell != 'undefined') {
                        jQuery('.wpie_field_editor_product_options_field').val(fieldOption.UpCrossSell).trigger('chosen:updated');
                } else {
                        jQuery('.wpie_field_editor_product_options_field').val('sku').trigger('chosen:updated');
                }
                jQuery('.wpie_field_editor_product_option_field').show();
        } else {
                jQuery('.wpie_field_editor_product_option_field').hide();
        }


        if (typeof fieldOption.phpFun != 'undefined')
        {
                jQuery('.wpie_export_php_fun_data').val(fieldOption.phpFun);

        } else {
                jQuery('.wpie_export_php_fun_data').val("");
        }

        if (fieldOption.isDate != 'undefined' && fieldOption.isDate == true)
        {
                if (typeof fieldOption.dateType != 'undefined')
                {
                        jQuery('.wpie_field_editor_date_field').val(fieldOption.dateType).trigger('chosen:updated');
                } else {
                        jQuery('.wpie_field_editor_date_field').val('php').trigger('chosen:updated');
                }

                if (typeof fieldOption.dateFormat != 'undefined')
                {
                        jQuery('.wpie_field_editor_date_field_format').val(fieldOption.dateFormat);
                } else {
                        jQuery('.wpie_field_editor_date_field_format').val('');
                }

                jQuery('.wpie_field_editor_date_field_wrapper').show();


        } else {
                jQuery('.wpie_field_editor_date_field_wrapper').hide();
        }


        jQuery('.wpie_field_editor_data').val(fieldName);

        jQuery('.wpie_content_data_field_list').val(oldValue).trigger('chosen:updated');

        jQuery('.wpie_field_editor_model').modal('show');

});
jQuery(document).on('change', '.wpie_export_php_fun', function () {

        jQuery('.wpie_export_php_fun_inner_wrapper').slideToggle('slow');

});
jQuery(document).on('click', '.wpie_export_save_field_btn', function () {

        var contentType = jQuery('.wpie_export_type_select').val();

        var label = jQuery('.wpie_field_editor_data').val();

        if (label == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.wpieExportEmptyFieldText);

                return false;
        }

        var value = jQuery('.wpie_content_data_field_list').val();

        if (value != "")
        {
                var fieldOption = JSON.parse(decodeURIComponent(jQuery('.wpie_content_data_field_list').val()));

                if (jQuery('.wpie_export_php_fun').is(":checked"))
                {
                        fieldOption.isPhp = true;
                } else
                {
                        fieldOption.isPhp = false;
                }

                fieldOption.phpFun = jQuery('.wpie_export_php_fun_data').val();

                if (fieldOption.isDate != 'undefined' && fieldOption.isDate == true)
                {
                        fieldOption.dateType = jQuery('.wpie_field_editor_date_field').val();

                        fieldOption.dateFormat = jQuery('.wpie_field_editor_date_field_format').val();
                }

                if (fieldOption.UpCrossSell != 'undefined')
                {
                        fieldOption.UpCrossSell = jQuery('.wpie_field_editor_product_options_field').val();

                }

                var fieldData = encodeURIComponent(JSON.stringify(fieldOption));

                if (jQuery('.wpie_fields_title_active').length > 0)
                {
                        var closest = jQuery('.wpie_fields_title_active');

                        closest.find('.wpie_fields_title').text(label);

                        closest.find('.wpie_fields_title').attr('field_data', fieldData);

                        closest.find('.wpie_fields_title').attr('old_field_data', value);
                } else {

                        var fieldHtml = wpieGenerateFieldsData(fieldData, value, label);

                        jQuery('.wpie_field_selection').append(fieldHtml);

                        if (typeof jQuery.fn.sortable === "function") {
                                jQuery('.wpie_field_selection').sortable("refresh");
                        }
                        if (typeof jQuery.fn.wpie_editable === "function") {
                                jQuery('.wpie_fields_title:not(.wpie_editable_container)').each(function () {
                                        jQuery(this).addClass('wpie_editable_container').wpie_editable('click', function (event) {
                                        });
                                });
                        }
                }
        }

        jQuery('.wpie_field_editor_model').modal('hide');

});
jQuery(document).on('click', '.wpie_save_template_btn', function () {

        var templateName = jQuery('.wpie_export_template_name').val();

        wpieSaveTemplate(0, templateName);

        jQuery('.wpie_export_template_name').val("");

});
jQuery(document).on('click', '.wpie_update_template_btn', function () {

        var template_id = jQuery('.wpie_template_list_select').val();

        if (template_id === "") {

                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.wpieEmptyTemplate);

                return false;
        }
        wpieSaveTemplate(template_id, "");

});

function wpieSaveTemplate(template_id, templateName)
{
        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType === "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;

        } else if (template_id === 0 && templateName === "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.enterSettingNameText);

                return false;
        }

        wpieShowLoader();

        var wpieFieldData = "";

        jQuery(".wpie_field_selection .wpie_fields_title").each(function (index, value) {

                var label = jQuery(this).text();

                var value = decodeURIComponent(jQuery(this).attr('field_data'));

                var other_option = decodeURIComponent(jQuery(this).attr('old_field_data'));

                wpieFieldData += label + "|~|" + value + "|~|" + other_option + "~||~";

        });

        jQuery('.wpie_export_fields_data').val(wpieFieldData);

        wpieSetFieldRuleData();


        var form_data = jQuery('.wpie_export_frm').serialize();

        jQuery.ajax({
                url: wpiePluginSettings.wpieAjaxURL,
                type: 'POST',
                data: "action=wpie_export_save_template&template_name=" + templateName + "&template_id=" + template_id + "&" + form_data,
                dataType: 'json',
                success: function (results) {

                        wpieHideLoader();

                        if (results.status == "error") {

                                wpieSetErrorMsg(results.message);

                                return false;

                        } else {

                                if (template_id === 0) {

                                        if (typeof results.template_id != 'undefined') {
                                                jQuery('.wpie_update_template_btn_wrapper').hide();
                                                jQuery('.wpie_template_list_select').append(new Option(templateName, results.template_id)).val("").trigger('chosen:updated');
                                        }
                                } else {

                                        if (typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined' && wpiePluginSettings.wpieExportData[contentType].templateData != 'undefined' && wpiePluginSettings.wpieExportData[contentType].templateData[template_id]) {
                                                delete wpiePluginSettings.wpieExportData[contentType].templateData[template_id];
                                        }
                                }

                                wpieSetSuccessMsg(results.message);
                        }
                },
                error: function (jqXHR, exception) {
                        wpieHandleAjaxError(jqXHR, exception);
                }
        });
}
jQuery(document).on('change', '.wpie_template_list_select', function () {

        wpieShowLoader();

        var templateId = jQuery(this).val();

        if (templateId == "")
        {
                wpieHideLoader();

                jQuery('.wpie_update_template_btn_wrapper').hide();

                return false;
        }

        jQuery('.wpie_update_template_btn_wrapper').show();

        jQuery('.wpie_export_settings_list_select').val('').trigger('chosen:updated');

        wpieChangeExportSettings(templateId);

});
jQuery(document).on('change', '.wpie_export_settings_list_select', function () {

        wpieShowLoader();

        var templateId = jQuery(this).val();

        if (templateId == "")
        {
                wpieHideLoader();

                return false;
        }

        jQuery('.wpie_template_list_select').val('').trigger('chosen:updated');

        jQuery('.wpie_update_template_btn_wrapper').hide();

        wpieChangeExportSettings(templateId);

});



function wpieChangeExportSettings(templateId) {

        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType === "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                wpieHideLoader();

                return false;
        }


        if (typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType].templateData != 'undefined' && typeof wpiePluginSettings.wpieExportData[contentType].templateData[templateId] != 'undefined')
        {
                wpieSetExportTemplate(wpiePluginSettings.wpieExportData[contentType].templateData[templateId]);

        } else
        {
                jQuery.ajax({
                        url: wpiePluginSettings.wpieAjaxURL,
                        type: 'GET',
                        data: "action=wpie_export_get_template_data&template_id=" + templateId,
                        dataType: 'json',
                        success: function (results) {

                                if (results.status == "error") {

                                        wpieSetErrorMsg(results.message);

                                        wpieHideLoader();

                                        return false;

                                } else {

                                        if (wpiePluginSettings.wpieExportData[contentType].templateData == 'undefined' || wpiePluginSettings.wpieExportData[contentType].templateData == null)
                                        {
                                                wpiePluginSettings.wpieExportData[contentType].templateData = [];
                                        }

                                        wpiePluginSettings.wpieExportData[contentType].templateData[templateId] = results.data;

                                        wpieSetExportTemplate(wpiePluginSettings.wpieExportData[contentType].templateData[templateId]);
                                }

                        },
                        error: function (jqXHR, exception) {
                                wpieHandleAjaxError(jqXHR, exception);
                        }

                });
        }
        wpieHideLoader();

}

function wpieSetExportTemplate(data)
{
        if (typeof data.wpie_csv_field_separator != 'undefined' && data.wpie_csv_field_separator != "")
        {
                jQuery('.wpie_csv_field_separator').val(data.wpie_csv_field_separator);
        } else {
                jQuery('.wpie_csv_field_separator').val(",");
        }
        if (typeof data.wpie_export_file_name != 'undefined' && data.wpie_export_file_name != "")
        {
                jQuery('.wpie_export_file_name').val(data.wpie_export_file_name);
        } else {
                jQuery('.wpie_export_file_name').val("");
        }
        if (typeof data.wpie_export_file_type != 'undefined' && data.wpie_export_file_type != "")
        {
                jQuery('.wpie_export_file_type').val(data.wpie_export_file_type).trigger('chosen:updated');
        } else {
                jQuery('.wpie_export_file_type').val("").trigger('chosen:updated');
        }
        if (typeof data.wpie_records_per_iteration != 'undefined' && data.wpie_records_per_iteration != "")
        {
                jQuery('.wpie_records_per_iteration').val(data.wpie_records_per_iteration);

        } else {
                jQuery('.wpie_records_per_iteration').val(50);
        }
        if (typeof data.wpie_export_include_bom != 'undefined' && data.wpie_export_include_bom != "")
        {
                jQuery('.wpie_export_include_bom').prop("checked", true);

        } else {
                jQuery('.wpie_export_include_bom').prop("checked", false);
        }
        if (typeof data.wpie_order_item_sigle_row != 'undefined' && data.wpie_order_item_sigle_row != "")
        {
                jQuery('.wpie_order_item_sigle_row').prop("checked", true);
                jQuery('.wpie_order_item_fill_empty_wrapper').slideDown();

        } else {
                jQuery('.wpie_order_item_sigle_row').prop("checked", false);
                jQuery('.wpie_order_item_fill_empty_wrapper').slideUp();
        }
        if (typeof data.wpie_order_item_fill_empty != 'undefined' && data.wpie_order_item_fill_empty != "")
        {
                jQuery('.wpie_order_item_fill_empty').prop("checked", true);

        } else {
                jQuery('.wpie_order_item_fill_empty').prop("checked", false);
        }

        if (typeof data.extra_copy_path != 'undefined' && data.extra_copy_path != "")
        {
                jQuery('.extra_copy_path').val(data.extra_copy_path);

        } else {
                jQuery('.extra_copy_path').val("");
        }

        wpiePluginSettings.wpieExportData.filterRule = {};

        wpiePluginSettings.wpieExportData.filterRuleNumber = 1;

        jQuery('.wpie_content_added_data_rule').html("");

        if (typeof data.wpie_export_condition != 'undefined' && data.wpie_export_condition != "")
        {
                jQuery('.wpie_content_added_data_rule').html('');

                var all_conditions = data.wpie_export_condition.split("~`|`~");

                if (typeof all_conditions[0] != 'undefined') {

                        // all_conditions = all_conditions.reverse();

                        var cond_rule = "";

                        jQuery.each(all_conditions, function (key, value) {

                                if (value != "") {

                                        var wpie_export_condition_new = value.split("`|~`");

                                        jQuery('.wpie_content_data_rule_fields').val(encodeURIComponent(wpie_export_condition_new[0])).trigger("change");

                                        jQuery('.wpie_content_data_rule_select').val(encodeURIComponent(wpie_export_condition_new[1])).trigger("change");

                                        jQuery('.wpie_content_data_rule_value').val(encodeURIComponent(wpie_export_condition_new[2]));

                                        wpieAddNewExportRule(cond_rule);

                                        if (typeof wpie_export_condition_new[3] != 'undefined' && wpie_export_condition_new[3] === "AND")
                                        {
                                                cond_rule = "AND";

                                        } else {
                                                cond_rule = "OR";
                                        }

                                }

                        });
                }

                jQuery('.wpie_content_data_rule_fields').val("").trigger('chosen:updated');

                jQuery('.wpie_content_data_rule_select').val("").trigger('chosen:updated');

                jQuery('.wpie_content_data_rule_value').val("");

        }
        if (typeof data.wpie_wpml_lang != 'undefined' && data.wpie_wpml_lang != "")
        {
                jQuery('.wpie_wpml_lang_' + data.wpie_wpml_lang).prop("checked", true);
        }
        if (typeof data.wpie_polylang_lang != 'undefined' && data.wpie_polylang_lang != "")
        {
                jQuery('.wpie_polylang_lang_' + data.wpie_polylang_lang).prop("checked", true);
        }

        if (typeof data.fields_data != 'undefined' && data.fields_data != "")
        {
                var fieldHtml = "";

                var fields_data_new = data.fields_data.split("~||~");

                jQuery.each(fields_data_new, function (key, value) {

                        var new_data = value.split("|~|");

                        var current_label = new_data[0];

                        var current_value = encodeURIComponent(new_data[1]);

                        var other_option = encodeURIComponent(new_data[2]);

                        if (current_label != "")
                        {
                                fieldHtml += wpieGenerateFieldsData(current_value, other_option, current_label);
                        }
                });

                jQuery('.wpie_field_selection').html(fieldHtml);

                if (typeof jQuery.fn.sortable === "function") {
                        jQuery('.wpie_field_selection').sortable("refresh");
                }

                if (typeof jQuery.fn.wpie_editable === "function") {
                        jQuery('.wpie_fields_title:not(.wpie_editable_container)').each(function () {
                                jQuery(this).addClass('wpie_editable_container').wpie_editable('click', function (event) {
                                });
                        });
                }
        }

        wpieSetSuccessMsg(wpiePluginSettings.wpieLocalizeText.selectSettingloadText);

        wpieAddProecess("wpieExportRecordCount");

        wpieExportRecordCount();
}
jQuery(document).on('change', '.wpie_content_data_field_list', function () {

        var label = jQuery(this).find("option:selected").text();

        jQuery('.wpie_field_editor_data').val(label);

        var fieldData = JSON.parse(decodeURIComponent(jQuery(this).val()));

        if (fieldData.isDate != 'undefined' && fieldData.isDate == true)
        {
                jQuery('.wpie_field_editor_date_field_wrapper').show();
        } else {
                jQuery('.wpie_field_editor_date_field_wrapper').hide();
        }

        if (fieldData.metaKey != 'undefined' && (fieldData.metaKey == '_upsell_ids' || fieldData.metaKey == '_crosssell_ids'))
        {
                jQuery('.wpie_field_editor_product_option_field').show();
        } else {
                jQuery('.wpie_field_editor_product_option_field').hide();
        }

});

jQuery(document).on('click', '.wpie_migrate_export_data_btn', function () {
        wpieProcessExport(1);
});

jQuery(document).on('click', '.wpie_export_data_btn', function () {
        wpieProcessExport(0);

});
function wpieProcessExport(is_package) {

        if (!wpieValidateExport())
        {
                return false;
        }

        wpiePluginSettings.wpieExportData.exportStatus = "export";

        wpiePluginSettings.wpieExportData.isPackage = is_package;

        wpiePluginSettings.wpieExportData.exportFileType = jQuery(".wpie_export_file_type").val();

        wpieGenerateFile();
}

jQuery(document).on('click', '.wpie_export_preview_btn', function () {

        if (!wpieValidateExport())
        {
                return false;
        }

        if (typeof wpiePluginSettings.wpieExportData.wpiePreviewTable != 'undefined') {
                wpiePluginSettings.wpieExportData.wpiePreviewTable.destroy();
        }

        var table = jQuery('.wpie_preview');

        var tr = jQuery("<tr>");

        jQuery(".wpie_field_selection .wpie_fields_title").each(function (index, value) {

                var label = jQuery(this).text();

                var th = jQuery("<th>").addClass("wpie_preview_header_data wpie_preview" + index).text(label);

                tr.append(th);
        });

        var thead = jQuery("<thead>").append(tr.clone());

        var tfoot = jQuery("<tfoot>").append(tr);

        table.html('').append(thead).append(tfoot);

        wpiePreviewData();

});
function wpiePreviewData()
{
        var contentType = jQuery('.wpie_export_type_select').val();

        var taxType = jQuery('.wpie_taxonomies_types_select').val();

        var total = 0;

        if (contentType == "taxonomies" && taxType != "")
        {
                if (typeof wpiePluginSettings.wpieExportData[contentType][taxType] != 'undefined') {

                        total = wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords;
                }
        } else {
                total = wpiePluginSettings.wpieExportData[contentType].totalRecords;
        }

        wpieGetFieldsData();

        wpieSetFieldRuleData();

        var form_data = jQuery('.wpie_export_frm').serializeArray();

        wpiePluginSettings.wpieExportData.wpiePreviewTable = jQuery('.wpie_preview').DataTable({
                "processing": true,
                "serverSide": true,
                "searching": false,
                "ordering": false,
                "columnDefs": [{
                                "render": jQuery.fn.dataTable.render.text(),
                                "targets": '_all'
                        }],
                "ajax": {
                        "url": wpiePluginSettings.wpieAjaxURL,
                        "type": "POST",
                        "cache": false,
                        "data": function (d) {

                                delete d.columns;

                                d.action = "wpie_export_get_preview_data";

                                d.total = total;

                                jQuery.each(form_data, function (key, val) {
                                        d[val.name] = val.value;
                                });

                        },
                        "complete": function (response) {

                        }

                },

        });

        jQuery('.wpie_preview_model').modal('show');
}
function wpieValidateExport() {

        var contentType = jQuery('.wpie_export_type_select').val();

        var taxType = jQuery('.wpie_taxonomies_types_select').val();

        if (contentType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;

        } else if (contentType == "taxonomies" && taxType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTaxTypeText);

                return false;

        } else if (jQuery(".wpie_field_selection .wpie_fields_title").length < 1)
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.wpieExportEmptyColumnText);

                return false;

        } else if (typeof wpiePluginSettings.wpieExportData[contentType] != 'undefined' && ((contentType != "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType].totalRecords != 'undefined' && wpiePluginSettings.wpieExportData[contentType].totalRecords < 1) || (contentType == "taxonomies" && typeof wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords != 'undefined' && wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords < 1)))
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.wpieExportEmptyDataText);

                return false;
        }

        return true;
}
function wpieValidateExportExt()
{
        var contentType = jQuery('.wpie_export_type_select').val();

        var isValid = true;

        var errorMsg = "";

        if (!Array.isArray(wpiePluginSettings.wpieExtensions)) {

                var wpieExt = [];
                if (!jQuery.isEmptyObject(wpiePluginSettings.wpieExtensions)) {
                        jQuery.each(wpiePluginSettings.wpieExtensions, function (ext) {

                                wpieExt.push(ext);
                        });
                }
                wpiePluginSettings.wpieExtensions = wpieExt;
        }
        if (contentType == "")
        {
                errorMsg = wpiePluginSettings.wpieLocalizeText.selectExportTypeText;

                isValid = false;

        } else if (jQuery.inArray(contentType, ["shop_customer", "shop_order", "shop_coupon", "product", "product_attributes", 'product_reviews']) !== -1) {

                errorMsg = wpiePluginSettings.wpieLocalizeText.wpiePremiumFeatureOnly;

                isValid = false;
        } else if (typeof wpiePluginSettings.isWcActive != 'undefined' && wpiePluginSettings.isWcActive != 1 && jQuery.inArray(contentType, ["shop_customer", "shop_order", "shop_coupon", "product", "product_attributes"]) !== -1) {

                errorMsg = wpiePluginSettings.wpieLocalizeText.ActivateWc;

                isValid = false;

        } else if (contentType == "users") {

                if (wpiePluginSettings.wpieExtensions.indexOf("wpie_user_export") < 0)
                {
                        errorMsg = wpiePluginSettings.wpieLocalizeText.wpieExportUserExtDisableText;

                        isValid = false;
                }
        } else if (contentType == "shop_customer") {

                if (wpiePluginSettings.wpieExtensions.indexOf("wpie_wc_export") < 0) {

                        errorMsg = wpiePluginSettings.wpieLocalizeText.wpieExportWCExtDisableText;

                        isValid = false;
                } else if (wpiePluginSettings.wpieExtensions.indexOf("wpie_user_export") < 0) {

                        errorMsg = wpiePluginSettings.wpieLocalizeText.wpieExportUserExtDisableText;

                        isValid = false;

                }
        } else if (contentType == "shop_order" || contentType == "shop_coupon" || contentType == "product") {

                if (wpiePluginSettings.wpieExtensions.indexOf("wpie_wc_export") < 0) {

                        errorMsg = wpiePluginSettings.wpieLocalizeText.wpieExportWCExtDisableText;

                        isValid = false;
                }
        } else if (contentType == "product_attributes") {

                if (wpiePluginSettings.wpieExtensions.indexOf("wpie_product_attribute_export") < 0) {

                        errorMsg = wpiePluginSettings.wpieLocalizeText.wpieExportattrExtDisableText;

                        isValid = false;
                }

        }
        if (isValid == false)
        {
                jQuery('.wpie_export_type_select').val("").trigger('chosen:updated');

                wpieRefreshExportData();

                wpieSetErrorMsg(errorMsg);

                return false;
        }

        return true;
}

jQuery(document).on('change', '.wpie_field_editor_date_field', function () {

        if (jQuery(this).val() == "php")
        {
                jQuery('.wpie_field_editor_date_field_format_wrapper').show();
        } else {
                jQuery('.wpie_field_editor_date_field_format_wrapper').hide();
        }
});

function wpieValidateProcess() {

        if (wpieIsValidTime() === false || wpieIsData() === false)
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.wpieInvalidLicense);

                return false;
        }
        return true;

}
function wpieGenerateFile()
{
        var contentType = jQuery('.wpie_export_type_select').val();

        if (typeof wpiePluginSettings.wpieExportData[contentType] == 'undefined' || wpiePluginSettings.wpieExportData[contentType] == null)
        {
                wpiePluginSettings.wpieExportData[contentType] = [];
        }

        jQuery('.wpie_export_notice').show();

        if (wpiePluginSettings.wpieExportData.isPackage == 1) {
                wpieAddAllFields();
        }

        wpieGetFieldsData();

        wpieSetFieldRuleData();

        var form_data = jQuery('.wpie_export_frm').serialize();

        var total = 0;

        if (wpiePluginSettings.wpieExportData[contentType] != 'undefined') {

                if (contentType == "taxonomies") {
                        var taxType = jQuery('.wpie_taxonomies_types_select').val();

                        if (wpiePluginSettings.wpieExportData[contentType][taxType] != 'undefined' && wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords != 'undefined' && wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords > 0)
                        {
                                total = wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords;
                        }

                } else {
                        if (wpiePluginSettings.wpieExportData[contentType].totalRecords != 'undefined' && wpiePluginSettings.wpieExportData[contentType].totalRecords > 0)
                        {
                                total = wpiePluginSettings.wpieExportData[contentType].totalRecords;
                        }
                }
        }

        jQuery.ajax({
                url: wpiePluginSettings.wpieAjaxURL,
                type: 'POST',
                data: "action=wpie_export_create_data&is_package=" + wpiePluginSettings.wpieExportData.isPackage + "&" + form_data + "&total=" + total,
                dataType: 'json',
                success: function (results) {
                        if (results.status == "error") {

                                wpieSetErrorMsg(results.message);

                                return false;
                        } else {

                                if (results.wpie_export_id != 0)
                                {
                                        wpieResetExportOptions()

                                        jQuery('.wpie_download_exported_file_id').val(results.export_id);

                                        wpiePluginSettings.wpieExportData.wpieExportId = results.export_id;

                                        delete wpiePluginSettings.wpieExportData.exportProcess;

                                        wpieExportAllData();
                                }
                        }
                }, error: function (jqXHR, exception) {
                        wpieHandleAjaxError(jqXHR, exception);
                }
        });
}
function wpieResetExportOptions() {
        jQuery('.wpie_remote_export_wrapper').hide();

        jQuery('.wpie_export_process .progress-bar').removeClass('wpie_completed');

        jQuery('.progress-bar').css("width", "0%").html("0%");

        jQuery('.wpie_export_process_header').html(jQuery('.wpie_export_process_header').attr('process_text'));

        jQuery('.wpie_export_process_per').html("0%");

        jQuery('.wpie_export_time_elapsed_value').html("00:00:00");

        jQuery('.wpie_export_total_records_value').html("0");

        jQuery('.wpie_export_process_btn_wrapper').hide();

        jQuery('.wpie_export_process_option_btn_wrapper').show();

        jQuery('.wpie_export_popup_wrapper').modal({backdrop: 'static', keyboard: false, show: true});

        clearInterval(wpiePluginSettings.wpieExportData.exportInterval);

        wpiePluginSettings.wpieExportData.exportIntervalSec = 0;

        wpiePluginSettings.wpieExportData.exportInterval = setInterval(function () {
                jQuery('.wpie_export_time_elapsed_value').html(wpieElapsedTimeString(wpiePluginSettings.wpieExportData.exportIntervalSec++));
        }, 1000);
}
function wpiePrettyTimeString(num) {
        return (num < 10 ? "0" : "") + num;
}

function wpieElapsedTimeString(Seconds) {

        var hours = Math.floor(Seconds / 3600);
        Seconds = Seconds % 3600;

        var minutes = Math.floor(Seconds / 60);
        Seconds = Seconds % 60;

        var seconds = Math.floor(Seconds);

        hours = wpiePrettyTimeString(hours);

        minutes = wpiePrettyTimeString(minutes);

        seconds = wpiePrettyTimeString(seconds);

        return hours + ":" + minutes + ":" + seconds;

}
function wpieExportAllData()
{
        var contentType = jQuery('.wpie_export_type_select').val();

        if (typeof wpiePluginSettings.wpieExportData.exportStatus != 'undefined') {

                if (wpiePluginSettings.wpieExportData.exportStatus == 'export')
                {
                        wpiePluginSettings.wpieExportData.exportProcess = jQuery.ajax({
                                url: wpiePluginSettings.wpieAjaxURL,
                                type: 'GET',
                                data: "action=wpie_export_update_data&export_id=" + wpiePluginSettings.wpieExportData.wpieExportId,
                                dataType: 'json',
                                success: function (results) {
                                        if (results.status == "error") {

                                                wpieSetErrorMsg(results.message);

                                                return false;
                                        } else {
                                                if (results.wpie_export_id != 0 && results.export_status != "completed")
                                                {

                                                        var exportedRecords = results.exported_records;

                                                        var totalPer = 0;

                                                        if (exportedRecords > 0) {

                                                                if (contentType == "taxonomies")
                                                                {
                                                                        var taxType = jQuery('.wpie_taxonomies_types_select').val();

                                                                        if (wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords > 0)
                                                                        {
                                                                                totalPer = parseInt(exportedRecords * 100 / wpiePluginSettings.wpieExportData[contentType][taxType].totalRecords);
                                                                        } else
                                                                        {
                                                                                totalPer = 100;
                                                                        }
                                                                } else {
                                                                        if (wpiePluginSettings.wpieExportData[contentType].totalRecords > 0)
                                                                        {
                                                                                totalPer = parseInt(exportedRecords * 100 / wpiePluginSettings.wpieExportData[contentType].totalRecords);
                                                                        } else
                                                                        {
                                                                                totalPer = 100;
                                                                        }
                                                                }

                                                        }

                                                        totalPer = totalPer < 100 ? totalPer : 100;

                                                        jQuery('.progress-bar').css("width", totalPer + "%").html(totalPer + "%");

                                                        jQuery('.wpie_export_total_records_value').html(exportedRecords);

                                                        wpieExportAllData();

                                                } else
                                                {
                                                        if (wpiePluginSettings.wpieExportData.isPackage == 1 || (!(wpiePluginSettings.wpieExportData.exportFileType == "" || wpiePluginSettings.wpieExportData.exportFileType == "csv"))) {

                                                                wpiePrepareExportFile();
                                                        }

                                                        jQuery('.wpie_export_proccess_title').html(wpiePluginSettings.wpieLocalizeText.wpieExportCompletedText);

                                                        exportedRecords = results.exported_records;

                                                        totalPer = 100;

                                                        clearInterval(wpiePluginSettings.wpieExportData.exportInterval);

                                                        jQuery('.wpie_export_process_btn_wrapper').show();

                                                        jQuery('.wpie_remote_export_wrapper').show();

                                                        jQuery('.wpie_export_process_option_btn_wrapper').hide();

                                                        jQuery('.progress-bar').css("width", "100%").html("100%");

                                                        jQuery('.wpie_export_total_records_value').html(exportedRecords);

                                                        jQuery('.wpie_export_process .progress-bar').addClass('wpie_completed');

                                                        jQuery('.wpie_export_notice').hide();
                                                }
                                        }
                                }, error: function (jqXHR, exception) {
                                        if (!(typeof wpiePluginSettings.wpieExportData.exportStatus != 'undefined' && wpiePluginSettings.wpieExportData.exportStatus == 'stop')) {
                                                wpieHandleAjaxError(jqXHR, exception);
                                        }
                                }
                        });
                } else if (wpiePluginSettings.wpieExportData.exportStatus == 'bg') {
                        wpie_update_export_status('bg');
                } else if (wpiePluginSettings.wpieExportData.exportStatus == 'pause') {

                        jQuery('.wpie_export_process_pause_btn').hide();

                        jQuery('.wpie_export_process_resume_btn').show();

                        var pauseInterval = setInterval(function () {

                                if ((!wpiePluginSettings.wpieExportData.exportProcess) || (wpiePluginSettings.wpieExportData.exportProcess && wpiePluginSettings.wpieExportData.exportProcess.readyState == 4)) {

                                        jQuery('.wpie_process_action').modal('hide');

                                        clearInterval(pauseInterval);

                                }
                        }, 1000);

                        clearInterval(wpiePluginSettings.wpieExportData.exportInterval);

                } else if (wpiePluginSettings.wpieExportData.exportStatus == 'stop') {

                        setTimeout(function () {
                                jQuery('.wpie_process_action').modal('hide');

                                jQuery('.wpie_export_popup_wrapper').modal('hide');
                        }, 2000);
                }
        }
}

function wpiePrepareExportFile()
{
        var task_list = {
                "wpiePrepareFile": wpiePluginSettings.wpieLocalizeText.wpiePrepareFile,
        }

        wpieSetProcessLoader(task_list);

        jQuery.ajax({
                url: wpiePluginSettings.wpieAjaxURL,
                type: 'GET',
                data: "action=wpie_export_prepare_file&export_id=" + wpiePluginSettings.wpieExportData.wpieExportId,
                dataType: 'json',
                success: function (results) {

                        wpieUpdateProcessLoader("wpiePrepareFile");

                        if (results.status == "error") {

                                wpieSetErrorMsg(results.message);

                                return false;
                        }

                }, error: function (jqXHR, exception) {
                        wpieHandleAjaxError(jqXHR, exception);
                }
        });
}
function wpie_update_export_status(status)
{
        setTimeout(function () {
                jQuery('.wpie_process_action').modal('hide');

                jQuery('.wpie_export_popup_wrapper').modal('hide');

        }, 1500);

        wpieShowLoader();

        jQuery.ajax({
                url: wpiePluginSettings.wpieAjaxURL,
                type: 'GET',
                data: "action=wpie_export_update_status&wpie_export_id=" + wpiePluginSettings.wpieExportData.wpieExportId + "&process_status=" + status,
                dataType: 'json',
                success: function (results) {

                        wpieHideLoader();

                        if (results.status == "error") {

                                wpieSetErrorMsg(results.message);

                                return false;
                        } else {
                                wpieSetSuccessMsg(results.message);

                        }
                }, error: function (jqXHR, exception) {
                        wpieHandleAjaxError(jqXHR, exception);
                }
        });

        wpieHideLoader();
}
jQuery(document).on('click', '.wpie_export_process_close_btn', function () {

        jQuery('.wpie_export_popup_wrapper').modal('hide');
});
jQuery(document).on('click', '.wpie_export_process_pause_btn', function () {

        jQuery('.wpie_process_action').modal({backdrop: 'static', keyboard: false, show: true});

        wpiePluginSettings.wpieExportData.exportStatus = "pause";

});

jQuery(document).on('click', '.wpie_export_bg_process_btn', function () {

        if (wpiePluginSettings.wpieExportData.exportStatus == "pause" && wpiePluginSettings.wpieExportData.exportProcess && wpiePluginSettings.wpieExportData.exportProcess.readyState == 4)
        {
                wpie_update_export_status("bg");

        } else {

                jQuery('.wpie_process_action').modal({backdrop: 'static', keyboard: false, show: true});

                wpiePluginSettings.wpieExportData.exportStatus = "bg";
        }

});

jQuery(document).on('click', '.wpie_export_process_stop_btn', function () {

        if (wpiePluginSettings.wpieExportData.exportStatus == 'pause')
        {
                jQuery('.wpie_export_popup_wrapper').modal('hide');
        }

        wpiePluginSettings.wpieExportData.exportStatus = "stop";

        jQuery('.wpie_process_action').modal('hide');

        jQuery('.wpie_export_popup_wrapper').modal('hide');

        if (wpiePluginSettings.wpieExportData.exportProcess && wpiePluginSettings.wpieExportData.exportProcess.readyState != 4) {
                wpiePluginSettings.wpieExportData.exportProcess.abort();
        }

});

jQuery(document).on('click', '.wpie_export_process_resume_btn', function () {

        wpiePluginSettings.wpieExportData.exportStatus = "export";

        jQuery('.wpie_export_process_pause_btn').show();

        jQuery('.wpie_export_process_resume_btn').hide();

        wpiePluginSettings.wpieExportData.exportInterval = setInterval(function () {
                jQuery('.wpie_export_time_elapsed_value').html(wpieElapsedTimeString(wpiePluginSettings.wpieExportData.exportIntervalSec++));
        }, 1000);

        wpieExportAllData();
});
jQuery(document).on('click', '.wpie_export_download_btn', function () {

        jQuery('.wpie_download_export_id').val(wpiePluginSettings.wpieExportData.wpieExportId);

        jQuery('.wpie_file_download_action').submit();

});
jQuery(document).on('change', '.wpie_order_item_sigle_row', function () {

        jQuery('.wpie_order_item_fill_empty_wrapper').slideToggle();

});

jQuery(document).on('change', '.wpie_wpml_lang,.wpie_polylang_lang', function () {

        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;
        }

        wpieShowLoader();

        wpieAddProecess("wpieExportRecordCount");

        wpieExportRecordCount();

});
jQuery(document).on('click', '.wpie_save_scheduled_btn', function () {

        if (wpieValidateExport() === false)
        {
                return false;
        }

        wpieShowLoader();

        var contentType = jQuery('.wpie_export_type_select').val();

        if (typeof wpiePluginSettings.wpieExportData[contentType] == 'undefined' || wpiePluginSettings.wpieExportData[contentType] == null)
        {
                wpiePluginSettings.wpieExportData[contentType] = [];
        }

        wpieGetFieldsData();

        wpieSetFieldRuleData();

        var form_data = jQuery('.wpie_export_frm').serialize();

        jQuery.ajax({
                url: wpiePluginSettings.wpieAjaxURL,
                type: 'POST',
                data: "action=wpie_export_save_schedule_data&" + form_data,
                dataType: 'json',
                success: function (results) {

                        wpieHideLoader();

                        if (results.status == "error") {

                                wpieSetErrorMsg(results.message);

                                return false;
                        } else {

                                wpieSetSuccessMsg(results.message);
                        }
                }, error: function (jqXHR, exception) {
                        wpieHandleAjaxError(jqXHR, exception);
                }
        });

});

function wpieGetFieldsData()
{
        var new_fields_data = "";

        jQuery(".wpie_field_selection .wpie_fields_title").each(function (index, value) {

                var label = jQuery(this).text();

                var value = decodeURIComponent(jQuery(this).attr('field_data'));

                var other_option = decodeURIComponent(jQuery(this).attr('old_field_data'));

                new_fields_data += label + "|~|" + value + "|~|" + other_option + "~||~";

        });

        jQuery('.wpie_export_fields_data').val(new_fields_data);

}
function wpieSetFieldRuleData()
{
        var ruleData = "";

        if (typeof wpiePluginSettings.wpieExportData.filterRule != 'undefined')
        {

                jQuery.each(wpiePluginSettings.wpieExportData.filterRule, function (index, wpieRule) {

                        var ruleCondition = "";

                        if (jQuery('.wpie_filter_data_rule_' + index).length && jQuery('.wpie_filter_data_rule_' + index).find('.wpie_rule_condition_option:checked').length)
                        {
                                ruleCondition = jQuery('.wpie_filter_data_rule_' + index).find('.wpie_rule_condition_option:checked').val();
                        }

                        ruleData += decodeURIComponent(wpieRule.fieldRule) + "`|~`" + wpieRule.fieldCondition + "`|~`" + wpieRule.fieldRuleValue + "`|~`" + ruleCondition + "~`|`~";
                });

        }
        jQuery('.wpie_filter_rule').val(ruleData);

        jQuery('.wpie_export_condition').val(ruleData);

}
function wpieSetProcessLoader(task_list) {

        var html = "";

        jQuery.each(task_list, function (key, text) {

                html += '<div class="wpie_task_wrapper ' + key + '" >';
                html += '<div class="wpie_task_icon_wrapper wpie_task_processing_icon"><i class="fas fa-spinner fa-spin wpie_spinner_btn_icon"></i></div>';
                html += '<div class="wpie_task_icon_wrapper wpie_task_completed_icon"><i class="fas fa-check-circle wpie_general_btn_icon " aria-hidden="true"></i></div>';
                html += '<div class="wpie_task_title">' + text + '</div>';
                html += '</div>'

        });

        jQuery('.wpie_task_list').html(html);

        jQuery('.wpie_processing_data').modal({backdrop: 'static', keyboard: false, show: true});
}
function wpieUpdateProcessLoader(key) {

        jQuery("." + key).addClass("task_completed");

        if (!jQuery('.wpie_task_list').find(".wpie_task_wrapper:not(.task_completed)").length)
        {
                jQuery('.wpie_processing_data').modal('hide');

                var isHide = setInterval(function () {

                        if (jQuery('.wpie_processing_data').hasClass('show')) {

                                jQuery('.wpie_processing_data').modal('hide');

                        } else {
                                clearInterval(isHide);
                        }
                }, 1000);
        }

}
jQuery(document).on('change', '.wpie_migrate_package', function () {

        if (jQuery(this).is(":checked"))
        {
                wpieAddAllFields();
        }
});
jQuery(document).on('change', '.wpie_export_file_type', function () {

        if (jQuery(this).val() === "xml")
        {
                jQuery('.wpie_skip_empty_nodes_wrapper').show();
        } else {
                jQuery('.wpie_skip_empty_nodes_wrapper').hide();
        }
});
jQuery(document).on('change', '.wpie_product_variation_options', function () {


        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;
        }

        var variation_option = jQuery(this).val();

        if (variation_option === "all") {
                jQuery('.wpie_migrate_export_data_btn').removeClass("disabled");
                jQuery('.wpie_export_product_variation_warning').hide();
        } else {
                jQuery('.wpie_export_product_variation_warning').show();
                jQuery('.wpie_migrate_export_data_btn').addClass("disabled");
        }

        wpieShowLoader();

        wpieAddProecess("wpieExportRecordCount");

        wpieExportRecordCount();

});
jQuery(document).on('change', '.wpie_export_only_customer_with_purchase', function () {


        var contentType = jQuery('.wpie_export_type_select').val();

        if (contentType == "")
        {
                wpieSetErrorMsg(wpiePluginSettings.wpieLocalizeText.selectExportTypeText);

                return false;
        }

        wpieShowLoader();

        wpieAddProecess("wpieExportRecordCount");

        wpieExportRecordCount();

});
jQuery(document).on('click', '.wpie_export_settings_list_select', function () {



});
